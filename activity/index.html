<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Ankur Taxali â€” Activity" />
  <title>Activity | Ankur Taxali</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  <div class="page-shell">
    <main class="frame">
      <header class="topbar">
        <a class="brand" href="/">Ankur.</a>
        <nav class="menu" aria-label="Primary">
          <a href="/">Home</a>
          <a href="/activity">Activity</a>
          <a href="/">Projects</a>
          <a href="/">Experience</a>
        </nav>
      </header>

      <section class="activity-page" aria-label="Contribution activity">
        <div class="activity-head">
          <h1>GitHub Activity</h1>
          <p id="activity-summary">Loading contribution data...</p>
        </div>

        <div class="activity-cards" id="activity-cards" aria-label="Contribution totals"></div>

        <section class="top-days-wrap" aria-label="Top commit days in the last year">
          <div class="top-days-head">
            <h2>Top Commit Days</h2>
            <p>Highest commit-count dates over the last 12 months</p>
          </div>
          <ol class="top-days-list" id="top-commit-days">
            <li class="top-days-empty">Loading commit-day rankings...</li>
          </ol>
        </section>

        <div class="calendar-wrap calendar-wrap-compact" id="calendar-3m-wrap" aria-label="Last three months contribution calendar"></div>

        <div class="calendar-wrap" id="calendar-wrap" aria-label="Contribution calendar"></div>

        <p class="activity-help" id="activity-help">
          Data source: GitHub GraphQL API (`contributionsCollection`).
        </p>
      </section>
    </main>
  </div>

  <script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
  <script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.min.js"></script>
  <script>
    (async function loadActivity() {
      const summary = document.getElementById("activity-summary");
      const cards = document.getElementById("activity-cards");
      const topCommitDays = document.getElementById("top-commit-days");
      const threeMonthWrap = document.getElementById("calendar-3m-wrap");
      const calendarWrap = document.getElementById("calendar-wrap");
      const help = document.getElementById("activity-help");
      const tippyInstances = [];

      function formatDate(value) {
        const date = new Date(value + "T00:00:00");
        return date.toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function monthLabel(value) {
        const date = new Date(value + "T00:00:00");
        return date.toLocaleDateString(undefined, { month: "short" });
      }

      function renderCards(totals) {
        const cardItems = [
          ["Total", totals.totalContributions],
          ["Commits", totals.commits],
          ["PRs", totals.pullRequests],
          ["Reviews", totals.reviews],
          ["Issues", totals.issues],
        ];

        cards.innerHTML = "";
        for (const item of cardItems) {
          const el = document.createElement("article");
          el.className = "activity-card";
          el.innerHTML =
            '<span class="label">' +
            item[0] +
            "</span>" +
            '<strong class="value">' +
            Number(item[1]).toLocaleString() +
            "</strong>";
          cards.appendChild(el);
        }
      }

      function levelForCount(count) {
        if (count <= 0) return 0;
        if (count <= 2) return 1;
        if (count <= 5) return 2;
        if (count <= 9) return 3;
        return 4;
      }

      function renderTopCommitDays(commitDays) {
        const topFive = (commitDays || [])
          .filter(function (day) {
            return Number(day && day.commitCount) > 0 && typeof day.date === "string";
          })
          .sort(function (a, b) {
            if (b.commitCount !== a.commitCount) {
              return b.commitCount - a.commitCount;
            }
            return a.date.localeCompare(b.date);
          })
          .slice(0, 5);

        topCommitDays.innerHTML = "";

        if (!topFive.length) {
          topCommitDays.innerHTML =
            '<li class="top-days-empty">No commit-day data found. Re-run the fetch script to populate this list.</li>';
          return;
        }

        topFive.forEach(function (item, index) {
          const li = document.createElement("li");
          li.className = "top-days-item";
          li.innerHTML =
            '<span class="top-days-rank">#' +
            String(index + 1) +
            "</span>" +
            '<span class="top-days-date">' +
            formatDate(item.date) +
            "</span>" +
            '<strong class="top-days-count">' +
            Number(item.commitCount).toLocaleString() +
            "</strong>";
          topCommitDays.appendChild(li);
        });
      }

      function renderCalendar(calendar, container, options) {
        const weeks = calendar.weeks || [];
        if (!weeks.length) {
          container.textContent = "No calendar data found.";
          return;
        }

        const weeksToShow = options && options.weeksToShow ? options.weeksToShow : weeks.length;
        const displayWeeks = weeks.slice(-weeksToShow);

        const grid = document.createElement("div");
        grid.className = "calendar-grid";

        const monthRow = document.createElement("div");
        monthRow.className = "calendar-months";

        const dayLabels = document.createElement("div");
        dayLabels.className = "calendar-days";
        dayLabels.innerHTML = '<span>Mon</span><span>Wed</span><span>Fri</span>';

        const weeksRow = document.createElement("div");
        weeksRow.className = "calendar-weeks";

        let lastMonth = "";
        displayWeeks.forEach(function (week, index) {
          const firstDay = week.contributionDays && week.contributionDays[0];
          const month = firstDay ? monthLabel(firstDay.date) : "";

          const monthMark = document.createElement("span");
          monthMark.className = "month-label";
          monthMark.style.gridColumn = String(index + 1);
          if (month && month !== lastMonth) {
            monthMark.textContent = month;
            lastMonth = month;
          }
          monthRow.appendChild(monthMark);

          const weekCol = document.createElement("div");
          weekCol.className = "week-col";

          const days = week.contributionDays || [];
          days.forEach(function (day) {
            const cell = document.createElement("span");
            cell.className = "day-cell level-" + levelForCount(day.contributionCount);
            const tip =
              day.contributionCount +
              " contribution" +
              (day.contributionCount === 1 ? "" : "s") +
              " on " +
              formatDate(day.date);
            cell.setAttribute("data-tip", tip);
            cell.setAttribute("aria-label", tip);
            weekCol.appendChild(cell);
          });

          weeksRow.appendChild(weekCol);
        });

        const weekCount = displayWeeks.length;
        monthRow.style.gridTemplateColumns = "repeat(" + weekCount + ", var(--cell-size, 10px))";
        weeksRow.style.gridTemplateColumns = "repeat(" + weekCount + ", var(--cell-size, 10px))";

        grid.appendChild(monthRow);
        grid.appendChild(dayLabels);
        grid.appendChild(weeksRow);

        container.innerHTML = "";
        container.appendChild(grid);
      }

      function initTooltips() {
        tippyInstances.forEach(function (instance) {
          instance.destroy();
        });
        tippyInstances.length = 0;

        if (typeof window.tippy !== "function") {
          return;
        }

        const cells = document.querySelectorAll(".day-cell[data-tip]");
        cells.forEach(function (cell) {
          const instance = window.tippy(cell, {
            content: cell.getAttribute("data-tip") || "",
            delay: [0, 0],
            duration: [90, 70],
            placement: "top",
            theme: "activity",
            arrow: false,
            offset: [0, 8],
          });
          tippyInstances.push(instance);
        });
      }

      try {
        const response = await fetch("./contributions.json", { cache: "no-store" });
        if (!response.ok) {
          throw new Error("No contributions.json yet. Run the fetch script first.");
        }

        const data = await response.json();
        summary.textContent =
          "@" +
          data.username +
          " has " +
          Number(data.totals.totalContributions).toLocaleString() +
          " contributions in the last year.";

        renderCards(data.totals);
        renderTopCommitDays(data.commitDays);
        renderCalendar(data.calendar, threeMonthWrap, { weeksToShow: 13 });
        renderCalendar(data.calendar, calendarWrap);
        initTooltips();

        if (data.fetchedAt) {
          help.textContent =
            "Data source: GitHub GraphQL API. Last fetched " +
            new Date(data.fetchedAt).toLocaleString() +
            ".";
        }
        if (data.commitDaysMayBeTruncated) {
          help.textContent += " Commit-day ranking may be truncated for very high-activity repositories.";
        }
      } catch (error) {
        summary.textContent = "Data check pending: " + error.message;
        cards.innerHTML = "";
        topCommitDays.innerHTML =
          '<li class="top-days-empty">Run the contribution fetch script to populate commit-day rankings.</li>';
        threeMonthWrap.textContent = "Run the contribution fetch script to populate this page.";
        calendarWrap.textContent = "Run the contribution fetch script to populate this page.";
      }
    })();
  </script>
</body>
</html>
